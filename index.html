<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¯å…¸åŠ©æ‰‹</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 15px; background-color: #f9f9f9; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header { font-size: 1.1em; font-weight: bold; color: #4a90e2; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .content { line-height: 1.6; font-size: 0.95em; white-space: pre-wrap; }
        .input-group { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 70%; }
        button { padding: 8px 12px; background: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .hidden { display: none; }
        .error { color: red; font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">ğŸ¤– AI æ·±åº¦é‡Šä¹‰</div>
    <div id="result" class="content">æ­£åœ¨å‡†å¤‡...</div>
    
    <div id="setup-area" class="input-group hidden">
        <p style="font-size:0.8em; color:#666;">é¦–æ¬¡ä½¿ç”¨éœ€é…ç½® API Key (ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ )</p>
        <input type="password" id="apiKeyInput" placeholder="è¯·è¾“å…¥ sk-xxxx å¼€å¤´çš„å¯†é’¥">
        <button onclick="saveKey()">ä¿å­˜</button>
    </div>
    
    <div style="margin-top:10px; font-size:0.8em; text-align:right;">
        <a href="#" onclick="clearKey()" style="color:#999; text-decoration:none;">é‡ç½®å¯†é’¥</a>
    </div>
</div>

<script>
    // --- é…ç½® ---
    const API_URL = 'https://api.openai.com/v1/chat/completions'; // å¦‚æœç”¨ä¸­è½¬ï¼Œè¯·ä¿®æ”¹æ­¤é“¾æ¥
    // -----------

    const resultDiv = document.getElementById('result');
    const setupArea = document.getElementById('setup-area');

    // è·å– URL å‚æ•°ä¸­çš„å•è¯
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return decodeURIComponent(pair[1]);}
        }
        return null;
    }

    // ä¿å­˜ Key åˆ°æµè§ˆå™¨
    function saveKey() {
        const input = document.getElementById('apiKeyInput').value;
        if(input.startsWith('sk-')) {
            localStorage.setItem('openai_key', input);
            setupArea.classList.add('hidden');
            location.reload(); // åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½
        } else {
            alert('å¯†é’¥æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹ï¼Œé€šå¸¸ä»¥ sk- å¼€å¤´');
        }
    }

    // æ¸…é™¤ Key
    function clearKey() {
        if(confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„å¯†é’¥å—ï¼Ÿ')) {
            localStorage.removeItem('openai_key');
            location.reload();
        }
    }

    async function main() {
        const apiKey = localStorage.getItem('openai_key');
        const word = getQueryVariable("q");

        // 1. æ£€æŸ¥æ˜¯å¦æœ‰ Key
        if (!apiKey) {
            resultDiv.innerHTML = "è¯·åœ¨ä¸‹æ–¹è®¾ç½®æ‚¨çš„ API Key ä»¥å¼€å§‹ä½¿ç”¨ã€‚";
            setupArea.classList.remove('hidden');
            return;
        }

        // 2. æ£€æŸ¥æ˜¯å¦æœ‰å•è¯
        if (!word) {
            resultDiv.innerHTML = "ç­‰å¾…æŸ¥è¯¢... (è¯·åœ¨æ¬§è·¯è¯å…¸ä¸­æµ‹è¯•)";
            return;
        }

        resultDiv.innerHTML = "ğŸ” æ­£åœ¨æ€è€ƒ " + word + " çš„å«ä¹‰...";

        // 3. å‘é€è¯·æ±‚
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system", 
                            content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹±è¯­å­¦ä¹ åŠ©æ‰‹ã€‚è¯·ç®€æ˜æ‰¼è¦åœ°è§£é‡Šç”¨æˆ·æä¾›çš„è‹±è¯­å•è¯ã€‚åŒ…å«ï¼š1. ä¸­æ–‡é‡Šä¹‰ 2. è¯æ ¹è¯ç¼€åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰3. ä¸€ä¸ªåœ°é“çš„è‹±æ–‡ä¾‹å¥ã€‚ä½¿ç”¨HTMLæ ‡ç­¾<b>åŠ ç²—</b>é‡ç‚¹ã€‚"
                        },
                        {role: "user", content: word}
                    ]
                })
            });

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error.message);
            }
            
            if (data.choices && data.choices.length > 0) {
                resultDiv.innerHTML = data.choices[0].message.content.replace(/\n/g, '<br>');
            }

        } catch (error) {
            resultDiv.innerHTML = `<span class="error">å‡ºé”™å•¦: ${error.message}</span><br>è¯·æ£€æŸ¥å¯†é’¥æˆ–ç½‘ç»œè¿æ¥ (å›½å†…éœ€ä½¿ç”¨ä¸­è½¬URL)ã€‚`;
        }
    }

    main();
</script>
</body>
</html>
