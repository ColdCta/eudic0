
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¯å…¸åŠ©æ‰‹</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: #f9f9f9; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header { font-size: 1.1em; font-weight: bold; color: #7d5fff; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .content { line-height: 1.6; white-space: pre-wrap; }
        
        /* è¾“å…¥åŒºåŸŸæ ·å¼ */
        .input-group { margin-top: 20px; border: 2px dashed #7d5fff; padding: 15px; background: #f0f0ff; border-radius: 8px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { padding: 10px 15px; background: #7d5fff; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; }
        
        /* çŠ¶æ€ç±» */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">ğŸ¤– Kimi åŠ©æ‰‹ (SiliconFlow)</div>
    
    <div id="result" class="content">å‡†å¤‡å°±ç»ª...</div>
    
    <div id="setup-area" class="input-group">
        <p style="margin-top:0; font-weight:bold;">âš™ï¸ é¦–æ¬¡é…ç½®</p>
        <p style="font-size:0.8em; color:#666; margin-bottom:10px;">è¯·è¾“å…¥ SiliconFlow å¯†é’¥ (sk-å¼€å¤´)ï¼š</p>
        <input type="password" id="apiKeyInput" placeholder="sk-gigbzfj...">
        <button onclick="saveKey()">ä¿å­˜å¯†é’¥å¹¶è¿æ¥</button>
        <p id="status-msg" style="font-size:0.8em; color:red;"></p>
    </div>
    
    <div style="margin-top:15px; font-size:0.8em; text-align:right;">
        <a href="#" onclick="clearKey()" style="color:#999;">é‡ç½®/æ›´æ¢å¯†é’¥</a>
    </div>
</div>

<script>
    // --- é…ç½® ---
    const CONFIG = {
        apiUrl: 'https://api.siliconflow.cn/v1/chat/completions',
        model: 'moonshotai/Kimi-K2-Thinking'
    };
    
    // --- é€»è¾‘ ---
    const resultDiv = document.getElementById('result');
    const setupArea = document.getElementById('setup-area');
    const statusMsg = document.getElementById('status-msg');

    // ä¿å­˜ Key
    function saveKey() {
        const input = document.getElementById('apiKeyInput').value.trim();
        if(!input) {
            statusMsg.innerText = "å¯†é’¥ä¸èƒ½ä¸ºç©º";
            return;
        }
        try {
            localStorage.setItem('sf_key', input);
            statusMsg.innerText = "ä¿å­˜æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...";
            setTimeout(() => location.reload(), 500);
        } catch (e) {
            statusMsg.innerText = "ä¿å­˜å¤±è´¥(æµè§ˆå™¨é™åˆ¶): " + e.message;
        }
    }

    // æ¸…é™¤ Key
    function clearKey() {
        if(confirm('ç¡®å®šè¦æ¸…é™¤å¯†é’¥å—ï¼Ÿ')) {
            localStorage.removeItem('sf_key');
            location.reload();
        }
    }

    // è·å– URL å‚æ•°
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return decodeURIComponent(pair[1]);}
        }
        return null;
    }

    async function main() {
        let apiKey = null;
        try {
            apiKey = localStorage.getItem('sf_key');
        } catch (e) {
            console.error("æ— æ³•è¯»å– LocalStorage");
        }

        const word = getQueryVariable("q");

        // 1. å¦‚æœæœ‰ Keyï¼Œéšè—è¾“å…¥æ¡†ï¼Œå¼€å§‹æŸ¥è¯
        if (apiKey) {
            setupArea.classList.add('hidden'); // åªæœ‰è¿™é‡Œæ‰ä¼šéšè—å®ƒ
            
            if (!word) {
                resultDiv.innerHTML = "ç­‰å¾…æŸ¥è¯... (è¯·åœ¨æ¬§è·¯è¯å…¸ä¸­æµ‹è¯•)";
                return;
            }

            resultDiv.innerHTML = "ğŸ¤” Kimi æ­£åœ¨æ€è€ƒ <b>" + word + "</b> ...";
            
            // å¼€å§‹è¯·æ±‚
            try {
                const response = await fetch(CONFIG.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: CONFIG.model,
                        messages: [
                            {
                                role: "system", 
                                content: "ä½ æ˜¯ä¸€ä¸ªè‹±è¯­å­¦ä¹ ä¸“å®¶ã€‚è¯·ç®€æ´åœ°è§£é‡Šè¯¥å•è¯ï¼š\n1. ä¸­æ–‡å®šä¹‰\n2. è¯æº/è®°å¿†æ³•\n3. 1ä¸ªç²¾ç®€ä¾‹å¥\nç”¨<b>åŠ ç²—</b>é‡ç‚¹ã€‚"
                            },
                            {role: "user", content: word}
                        ]
                    })
                });
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                if (data.choices && data.choices.length > 0) {
                    let text = data.choices[0].message.content;
                    resultDiv.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                }

            } catch (err) {
                resultDiv.innerHTML = `<span style="color:red">è¯·æ±‚å¤±è´¥: ${err.message}</span>`;
            }

        } else {
            // 2. å¦‚æœæ²¡æœ‰ Keyï¼Œä¿æŒè¾“å…¥æ¡†æ˜¾ç¤ºï¼Œæç¤ºç”¨æˆ·
            resultDiv.innerHTML = "è¯·å…ˆé…ç½®å¯†é’¥ ğŸ‘‡";
        }
    }

    main();
</script>
</body>
</html>
